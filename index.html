<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <title>Document</title>
</head>

<body>
  <header>
    <div class="app_header">
      <div class="app_auth_buttons">
        <button>
          <a href="#">Login</a>
        </button>
        |
        <button>
          <a href="#">Register</a>
        </button>

      </div>
    </div>
  </header>

  <main class="app_main">
    <div class="app_main_grid">

      <article class="app_card">
        <section class="card_category" draggable="true">Programming 1</section>
        <section class="card_to_do_section">
          <ul>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_card">
        <section class="card_category" draggable="true">Programming 1</section>
        <section class="card_to_do_section">
          <ul>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

            <article class="app_card">
        <section class="card_category" draggable="true">Programming 1</section>
        <section class="card_to_do_section">
          <ul>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

            <article class="app_card">
        <section class="card_category" draggable="true">Programming 1</section>
        <section class="card_to_do_section">
          <ul>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

            <article class="app_card">
        <section class="card_category" draggable="true">Programming 1</section>
        <section class="card_to_do_section">
          <ul>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

            <article class="app_card">
        <section class="card_category" draggable="true">Programming 1</section>
        <section class="card_to_do_section">
          <ul>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

            <article class="app_card">
        <section class="card_category" draggable="true">Programming 1</section>
        <section class="card_to_do_section">
          <ul>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_add_card">
        <section>
          <button>
            <span class="plus">+</span>
            <br> Add New Category
          </button>
        </section>
      </article>

    </div>
  </main>

  <footer>
    <div class="app_footer">
      &copy; Alex Levitskiy 2025
    </div>
  </footer>
</body>
<script>
  const grid = document.querySelector('.app_main_grid');
  let draggedEl = null;

  function animateFlip(elements, beforeRects) {
    const animations = [];

    elements.forEach(el => {
      const first = beforeRects.get(el);
      const last = el.getBoundingClientRect();

      if (!first) return;

      const dx = first.left - last.left;
      const dy = first.top - last.top;

      if (dx === 0 && dy === 0) return;

      const anim = el.animate([
        { transform: `translate(${dx}px, ${dy}px)` },
        { transform: 'translate(0, 0)' }
      ], {
        duration: 300,
        easing: 'ease'
      });

      animations.push(anim.finished);
    });

    return Promise.all(animations); // Вернёт промис, который завершится, когда все анимации закончатся
  }

  grid.addEventListener('mousedown', onMouseDown);

  let startX = 0, startY = 0;
  let offsetX = 0, offsetY = 0;
  let placeholder = null;


  
  let dragTimeout = null;
  let isDragging = false;
  let dragCancelled = false;

  function onMouseDown(e) {
    const target = e.target.closest('.app_card');
    if (!target) return;

    const rect = target.getBoundingClientRect();
    draggedEl = target;

    startX = e.clientX;
    startY = e.clientY;
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;

    dragCancelled = false;

    const cancelDragStart = () => {
      clearTimeout(dragTimeout);
      dragCancelled = true;
      document.removeEventListener('mouseup', cancelDragStart);
      target.removeEventListener('mouseleave', cancelDragStart);
    };

    document.addEventListener('mouseup', cancelDragStart);
    target.addEventListener('mouseleave', cancelDragStart);

    dragTimeout = setTimeout(() => {
      if (dragCancelled) return;

      // Удаляем cancel-слушатели
      document.removeEventListener('mouseup', cancelDragStart);
      target.removeEventListener('mouseleave', cancelDragStart);

      // Создаём placeholder
      placeholder = document.createElement('article');
      placeholder.className = 'app_card_placeholder';
      placeholder.style.width = rect.width + 'px';
      placeholder.style.height = rect.height + 'px';
      grid.insertBefore(placeholder, target.nextSibling);

      // Перемещаем карточку в body
      draggedEl.classList.add('dragging');
      draggedEl.style.width = `${rect.width}px`;
      draggedEl.style.height = `${rect.height}px`;
      document.body.appendChild(draggedEl);

      moveAt(e.pageX, e.pageY);

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      isDragging = true;
    }, 300); // Задержка перед началом drag
  }

  function moveAt(pageX, pageY) {
    draggedEl.style.left = pageX - offsetX + 'px';
    draggedEl.style.top = pageY - offsetY + 'px';
  }

  let lastOrderRects = new Map();

  let animationInProgress = false;

  async function onMouseMove(e) {
    if (!isDragging) return; // Если не в режиме перетаскивания, ничего не делаем

    moveAt(e.pageX, e.pageY); // всегда обновляем позицию

    if (animationInProgress) return; // остальное не трогаем, если анимация

    const allCards = [...grid.querySelectorAll('.app_card')];
    const cards = allCards.filter(c => c !== placeholder);

    const mouseX = e.clientX;
    const mouseY = e.clientY;

    for (const card of cards) {

      const rect = card.getBoundingClientRect();
      const isInsideY = mouseY > rect.top && mouseY < rect.bottom;
      const isInsideX = mouseX > rect.left && mouseX < rect.right;

      if (isInsideX && isInsideY) {
        const centerX = rect.left + rect.width / 2;
        const currentIndex = allCards.indexOf(placeholder);
        const targetIndex = allCards.indexOf(card);
        const direction = mouseX < centerX ? 'before' : 'after';


        // 1. Сохраняем старые позиции
        const lastRects = new Map();
        cards.forEach(el => lastRects.set(el, el.getBoundingClientRect()));

        // 2. Меняем DOM
        if (direction === 'before') {
          grid.insertBefore(placeholder, card);
        } else {
          grid.insertBefore(placeholder, card.nextSibling);
        }

        // 3. Анимация без блокировки мыши
        animationInProgress = true;
        const updatedCards = [...grid.querySelectorAll('.app_card')].filter(c => c !== placeholder);
        animateFlip(updatedCards, lastRects).then(() => {
          animationInProgress = false;
        });

        break;
      }
    }
  }

  function onMouseUp(e) {
    clearTimeout(dragTimeout);

    if (isDragging) {
      placeholder.replaceWith(draggedEl);
      draggedEl.classList.remove('dragging');
      draggedEl.style = '';
      document.removeEventListener('mousemove', onMouseMove);
      isDragging = false;
    }

    document.removeEventListener('mouseup', onMouseUp);
    draggedEl = null;
  }

  document.querySelectorAll('.card_to_do_section input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      const span = e.target.closest('label').querySelector('.editable');
      if (e.target.checked) {
        span.classList.add('completed');
      } else {
        span.classList.remove('completed');
      }
    });

    // предотвратием перенос клика с label на input
    checkbox.parentElement.addEventListener('click', (e) => {
      if (e.target !== checkbox) e.preventDefault();
    });
  });

  // Добавляем обработчик для редактируемых элементов
  document.querySelectorAll('.editable').forEach(span => {
    span.addEventListener('blur', (e) => {
      const text = e.target.textContent.trim();
      if (text === '') {
        e.target.textContent = 'New Task';
      }
    });
  });

  // Добавляем обработчик для кнопки "Add New Task"
  document.querySelectorAll('.app_card_new_task_btn').forEach(button => {
    button.addEventListener('click', () => {
      const newTask = prompt('Enter new task:');
      if (newTask) {
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="checkbox" /> <span class="editable" contenteditable="true">${newTask}</span></label>`;
        button.previousElementSibling.querySelector('ul').appendChild(li);
      }
    });
  });

</script>

</html>