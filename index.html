<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <title>Document</title>
</head>

<body>
  <header>
    <div class="app_header">
      <div class="app_auth_buttons">
        <button>
          <a href="#">Login</a>
        </button>
        |
        <button>
          <a href="#">Register</a>
        </button>

      </div>
    </div>
  </header>

  <main class="app_main">
    <div class="app_main_grid">

      <article class="app_card">
        <section class="card_category" draggable="false">Programming 1</section>
        <section class="card_to_do_section">
          <ul class="task_list">
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_card">
        <section class="card_category" draggable="false">Programming 1</section>
        <section class="card_to_do_section">
          <ul class="task_list">
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_card">
        <section class="card_category" draggable="false">Programming 1</section>
        <section class="card_to_do_section">
          <ul class="task_list">
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_card">
        <section class="card_category" draggable="false">Programming 1</section>
        <section class="card_to_do_section">
          <ul class="task_list">
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_card">
        <section class="card_category" draggable="false">Programming 1</section>
        <section class="card_to_do_section">
          <ul class="task_list">
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_card">
        <section class="card_category" draggable="false">Programming 1</section>
        <section class="card_to_do_section">
          <ul class="task_list">
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn SQLAlchemy</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn FastAPI</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
            <li>
              <label>
                <input type="checkbox" />
                <span class="editable" contenteditable="true">Learn React</span>
              </label>
              <button class="delete_task_btn" title="Удалить задачу">✖</button>
            </li>
          </ul>
        </section>
        <section class="app_card_new_task_section">
          <button class="app_card_new_task_btn">+ Add New Task</button>
        </section>
      </article>

      <article class="app_add_card">
        <section>
          <button>
            <span class="plus">+</span>
            <br> Add New Category
          </button>
        </section>
      </article>

    </div>
  </main>

  <footer>
    <div class="app_footer">
      &copy; Alex Levitskiy 2025
    </div>
  </footer>
</body>
<script>
  const grid = document.querySelector('.app_main_grid');
  let draggedEl = null;
  let placeholder = null;
  let startX = 0, startY = 0;
  let offsetX = 0, offsetY = 0;
  let isDragging = false;
  let dragTimeout = null;
  let dragCancelled = false;
  let animationInProgress = false;

  // Кэш размеров карточек
  let cardRects = new Map();

  function cacheCardRects() {
    cardRects.clear();
    grid.querySelectorAll('.app_card').forEach(card => {
      if (!card.classList.contains('dragging')) {
        cardRects.set(card, card.getBoundingClientRect());
      }
    });
  }

  // FLIP-анимация
  function animateFlip(elements, beforeRects) {
    const animations = [];
    elements.forEach(el => {
      const first = beforeRects.get(el);
      if (!first) return;
      const last = el.getBoundingClientRect();
      const dx = first.left - last.left;
      const dy = first.top - last.top;
      if (dx || dy) {
        const anim = el.animate([
          { transform: `translate(${dx}px, ${dy}px)` },
          { transform: 'translate(0, 0)' }
        ], { duration: 300, easing: 'ease' });
        animations.push(anim.finished);
      }
    });
    return Promise.all(animations);
  }

  // Начало перетаскивания
  grid.addEventListener('mousedown', onMouseDown);

  function onMouseDown(e) {
    const target = e.target.closest('.app_card');
    if (!target) return;

    const rect = target.getBoundingClientRect();
    draggedEl = target;
    startX = e.clientX;
    startY = e.clientY;
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    dragCancelled = false;

    const cancelDragStart = () => {
      clearTimeout(dragTimeout);
      dragCancelled = true;
      document.removeEventListener('mouseup', cancelDragStart);
      target.removeEventListener('mouseleave', cancelDragStart);
    };

    document.addEventListener('mouseup', cancelDragStart);
    target.addEventListener('mouseleave', cancelDragStart);

    dragTimeout = setTimeout(() => {
      if (dragCancelled) return;

      document.removeEventListener('mouseup', cancelDragStart);
      target.removeEventListener('mouseleave', cancelDragStart);

      placeholder = document.createElement('article');
      placeholder.className = 'app_card_placeholder';
      placeholder.style.width = rect.width + 'px';
      placeholder.style.height = rect.height + 'px';
      grid.insertBefore(placeholder, target.nextSibling);

      draggedEl.classList.add('dragging');
      draggedEl.style.width = rect.width + 'px';
      draggedEl.style.height = rect.height + 'px';
      draggedEl.style.position = 'absolute';
      draggedEl.style.zIndex = 1000;
      document.body.appendChild(draggedEl);

      moveAt(e.pageX, e.pageY);

      // Кэшируем размеры карточек
      cacheCardRects();

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      isDragging = true;
    }, 200); // задержка перед drag
  }

  function moveAt(pageX, pageY) {
    draggedEl.style.left = pageX - offsetX + 'px';
    draggedEl.style.top = pageY - offsetY + 'px';
  }

  // Перетаскивание
  async function onMouseMove(e) {
    if (!isDragging) return;
    moveAt(e.pageX, e.pageY);

    if (animationInProgress) return;

    const allCards = [...grid.querySelectorAll('.app_card')];
    const cards = allCards.filter(c => c !== placeholder);

    const mouseX = e.clientX;
    const mouseY = e.clientY;

    for (const card of cards) {
      const rect = cardRects.get(card);
      if (!rect) continue;

      const isInsideX = mouseX > rect.left && mouseX < rect.right;
      const isInsideY = mouseY > rect.top && mouseY < rect.bottom;

      if (isInsideX && isInsideY) {
        const centerX = rect.left + rect.width / 2;
        const direction = mouseX < centerX ? 'before' : 'after';
        const currentIndex = [...grid.children].indexOf(placeholder);
        const targetIndex = [...grid.children].indexOf(card);

        // Если placeholder уже в нужном месте — не трогаем
        const nextSibling = direction === 'before' ? card : card.nextSibling;
        if (placeholder.nextSibling === nextSibling) break;

        // Сохраняем позиции для FLIP
        const lastRects = new Map();
        cards.forEach(c => lastRects.set(c, c.getBoundingClientRect()));

        // Вставляем placeholder
        if (direction === 'before') grid.insertBefore(placeholder, card);
        else grid.insertBefore(placeholder, card.nextSibling);

        // Анимация
        animationInProgress = true;
        const updatedCards = [...grid.querySelectorAll('.app_card')].filter(c => c !== placeholder);
        animateFlip(updatedCards, lastRects).then(() => animationInProgress = false);
        break;
      }
    }
  }

  // Завершение перетаскивания
  function onMouseUp(e) {
    clearTimeout(dragTimeout);
    if (isDragging) {
      placeholder.replaceWith(draggedEl);
      draggedEl.classList.remove('dragging');
      draggedEl.style = '';
      document.removeEventListener('mousemove', onMouseMove);
      isDragging = false;
    }
    document.removeEventListener('mouseup', onMouseUp);
    draggedEl = null;
  }


  // --- чекбоксы ---
  grid.addEventListener('change', (e) => {
    if (e.target.matches('.card_to_do_section input[type="checkbox"]')) {
      const span = e.target.closest('label').querySelector('.editable');
      span.classList.toggle('completed', e.target.checked);
    }
  });

  // предотвращаем перенос клика с label на input
  grid.addEventListener('click', (e) => {
    if (e.target.closest('.card_to_do_section label')) {
      const checkbox = e.target.closest('label').querySelector('input[type="checkbox"]');
      if (e.target !== checkbox) e.preventDefault();
    }
  });

  // --- кнопка добавления задачи ---
  grid.addEventListener('click', (e) => {
    if (e.target.matches('.delete_task_btn')) {
      const li = e.target.closest('li');
      if (li) li.remove();
    }

    if (e.target.matches('.app_card_new_task_btn')) {
      const appCard = e.target.closest('.app_card');
      const taskList = appCard.querySelector('.task_list');

      const li = document.createElement('li');
      li.innerHTML = `
      <label>
        <input type="checkbox" />
        <span class="editable" contenteditable="true">New Task</span>
      </label>
    `;
      taskList.appendChild(li);

      const editableSpan = li.querySelector('.editable');
      editableSpan.focus();

      editableSpan.addEventListener('blur', () => {
        if (editableSpan.textContent.trim() === '') {
          editableSpan.textContent = 'New Task';
        }
      });
    }
  });

  // --- редактирование категории ---
  grid.addEventListener('dblclick', (e) => {
    if (e.target.matches('.card_category')) {
      e.target.setAttribute('contenteditable', 'true');
      e.target.focus();
    }
  });

  appGrid.addEventListener('blur', (e) => {
    if (e.target.matches('.card_category')) {
      e.target.removeAttribute('contenteditable');
      if (e.target.textContent.trim() === '') {
        e.target.textContent = 'Untitled';
      }
    }
  }, true); // используем capture, чтобы событие ловилось при уходе фокуса


</script>


</html>